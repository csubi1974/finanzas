import OpenAI from 'openai';

// Configurar cliente de OpenAI
const openai = new OpenAI({
  apiKey: import.meta.env.VITE_OPENAI_API_KEY,
  dangerouslyAllowBrowser: true // Solo para desarrollo, en producci√≥n usar backend
});

/**
 * Servicio para manejar consultas financieras con OpenAI
 */
export class FinancialChatService {
  constructor() {
    this.conversationHistory = [];
  }

  /**
   * Valida y limpia el contexto financiero
   * @param {Object} context - Contexto financiero del usuario
   * @returns {Object} - Contexto validado y limpio
   */
  validateFinancialContext(context) {
    if (!context) {
      return {
        balance: 0,
        transactions: [],
        monthlyIncome: 0,
        monthlyExpenses: 0,
        avgMonthlyIncome: 0,
        avgMonthlyExpenses: 0,
        savingsGoals: [],
        categoryAnalysis: {},
        spendingTrends: [],
        transactionCount: 0
      };
    }

    // Validar y limpiar datos num√©ricos
    const cleanNumber = (value) => {
      const num = parseFloat(value) || 0;
      return isNaN(num) ? 0 : num;
    };

    const validatedContext = {
      ...context,
      balance: cleanNumber(context.balance),
      monthlyIncome: cleanNumber(context.monthlyIncome),
      monthlyExpenses: cleanNumber(context.monthlyExpenses),
      avgMonthlyIncome: cleanNumber(context.avgMonthlyIncome),
      avgMonthlyExpenses: cleanNumber(context.avgMonthlyExpenses),
      transactions: Array.isArray(context.transactions) ? context.transactions : [],
      savingsGoals: Array.isArray(context.savingsGoals) ? context.savingsGoals : [],
      transactionCount: context.transactionCount || (context.transactions ? context.transactions.length : 0)
    };

    // Verificar consistencia de datos
    if (validatedContext.transactions.length > 0) {
      const calculatedTotal = validatedContext.transactions
        .filter(t => t.type === 'expense')
        .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
      
      // Si hay una gran discrepancia, agregar nota de advertencia
      if (Math.abs(calculatedTotal - validatedContext.avgMonthlyExpenses * 3) > validatedContext.avgMonthlyExpenses) {
        validatedContext._dataWarning = 'Los datos pueden tener inconsistencias. Verificar c√°lculos.';
      }
    }

    return validatedContext;
  }

  /**
   * Verifica que los datos pertenezcan al usuario correcto
   * @param {Object} context - Contexto financiero
   * @param {Object} user - Usuario autenticado
   * @returns {boolean} - True si los datos son v√°lidos para el usuario
   */
  validateUserData(context, user) {
    if (!user || !user.id) {
      console.warn('‚ö†Ô∏è Usuario no autenticado o sin ID');
      return false;
    }

    // Verificar que las transacciones tengan user_id correcto
    if (context.transactions && context.transactions.length > 0) {
      const invalidTransactions = context.transactions.filter(t => 
        t.user_id && t.user_id !== user.id
      );
      
      if (invalidTransactions.length > 0) {
        console.error('üö® ALERTA DE SEGURIDAD: Transacciones de otros usuarios detectadas:', {
          usuarioActual: user.id,
          transaccionesInvalidas: invalidTransactions.length,
          ejemploInvalido: invalidTransactions[0]
        });
        return false;
      }
    }


    return true;
  }

  /**
   * Detecta inconsistencias espec√≠ficas en los datos financieros
   * @param {Object} context - Contexto financiero validado
   * @returns {Array} - Lista de inconsistencias detectadas
   */
  detectDataInconsistencies(context) {
    const inconsistencies = [];

    // Verificar si los promedios mensuales son consistentes con las transacciones
    if (context.transactions && context.transactions.length > 0) {
      const expenseTransactions = context.transactions.filter(t => t.type === 'expense');
      const incomeTransactions = context.transactions.filter(t => t.type === 'income');
      
      const calculatedExpenses = expenseTransactions.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
      const calculatedIncome = incomeTransactions.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);

      // Verificar gastos
      if (Math.abs(calculatedExpenses - context.monthlyExpenses) > context.monthlyExpenses * 0.1) {
        inconsistencies.push(`Discrepancia en gastos: calculado $${calculatedExpenses.toLocaleString()} vs reportado $${context.monthlyExpenses.toLocaleString()}`);
      }

      // Verificar ingresos
      if (Math.abs(calculatedIncome - context.monthlyIncome) > context.monthlyIncome * 0.1) {
        inconsistencies.push(`Discrepancia en ingresos: calculado $${calculatedIncome.toLocaleString()} vs reportado $${context.monthlyIncome.toLocaleString()}`);
      }
    }

    // Verificar si los promedios son razonables
    if (context.avgMonthlyExpenses > context.monthlyExpenses * 5) {
      inconsistencies.push('El promedio mensual de gastos parece muy alto comparado con el mes actual');
    }

    if (context.avgMonthlyIncome > context.monthlyIncome * 5) {
      inconsistencies.push('El promedio mensual de ingresos parece muy alto comparado con el mes actual');
    }

    return inconsistencies;
  }

  /**
   * Procesa una consulta del usuario con contexto financiero
   * @param {string} userMessage - Mensaje del usuario
   * @param {Object} financialContext - Contexto financiero del usuario
   * @param {Object} user - Usuario autenticado
   * @returns {Promise<string>} - Respuesta del asistente
   */
  async processQuery(userMessage, financialContext, user) {
    try {
      // Validar y limpiar el contexto financiero
      const validatedContext = this.validateFinancialContext(financialContext);
      
      // Validar que los datos pertenezcan al usuario correcto
      if (!this.validateUserData(validatedContext, user)) {
        throw new Error('Error de seguridad: Los datos no pertenecen al usuario autenticado');
      }
      

      
      // Detectar inconsistencias en los datos
      const inconsistencies = this.detectDataInconsistencies(validatedContext);
      if (inconsistencies.length > 0) {
        validatedContext._inconsistencies = inconsistencies;

      }
      
      // Construir el contexto del sistema
      const systemPrompt = this.buildSystemPrompt(validatedContext);
      
      // Agregar mensaje del usuario al historial
      this.conversationHistory.push({
        role: 'user',
        content: userMessage
      });

      // Preparar mensajes para OpenAI
      const messages = [
        {
          role: 'system',
          content: systemPrompt
        },
        ...this.conversationHistory.slice(-10) // Mantener solo los √∫ltimos 10 mensajes
      ];

      // Llamar a OpenAI
      const completion = await openai.chat.completions.create({
        model: 'gpt-4.1-nano',
        messages: messages,
        max_tokens: 500,
        temperature: 0.5,
        presence_penalty: 0.1,
        frequency_penalty: 0.1
      });

      const assistantResponse = completion.choices[0].message.content;
      
      // Agregar respuesta al historial
      this.conversationHistory.push({
        role: 'assistant',
        content: assistantResponse
      });

      return assistantResponse;
    } catch (error) {
      console.error('Error en OpenAI:', error);
      throw new Error('Error al procesar la consulta. Por favor, intenta de nuevo.');
    }
  }

  /**
   * Construye el prompt del sistema con contexto financiero
   * @param {Object} context - Contexto financiero del usuario
   * @returns {string} - Prompt del sistema
   */
  buildSystemPrompt(context) {
    const {
      balance = 0,
      transactions = [],
      monthlyIncome = 0,
      monthlyExpenses = 0,
      avgMonthlyIncome = 0,
      avgMonthlyExpenses = 0,
      savingsGoals = [],
      categoryAnalysis = {},
      spendingTrends = [],
      transactionCount = 0
    } = context;

    // Calcular estad√≠sticas b√°sicas
    const recentTransactions = transactions.slice(-10);
    const topCategories = this.getTopCategories(transactions);
    const totalExpenses = transactions
      .filter(t => t.type === 'expense')
      .reduce((sum, t) => sum + parseFloat(t.amount), 0);
    const totalIncome = transactions
      .filter(t => t.type === 'income')
      .reduce((sum, t) => sum + parseFloat(t.amount), 0);
    
    // Obtener informaci√≥n de fecha actual
    const currentDate = new Date();
    const dayOfMonth = currentDate.getDate();
    const monthName = currentDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
    
    // Determinar per√≠odo del mes para contexto
    let monthPeriod = '';
    let periodAdvice = '';
    
    if (dayOfMonth <= 10) {
      monthPeriod = 'INICIO DE MES';
      periodAdvice = '‚ö†Ô∏è IMPORTANTE: Estamos a inicio de mes. Es probable que a√∫n no hayas realizado todos tus pagos fijos (renta, servicios, seguros). El saldo actual NO refleja tu ahorro real disponible.';
    } else if (dayOfMonth <= 20) {
      monthPeriod = 'MEDIADOS DE MES';
      periodAdvice = 'üìä CONTEXTO: Estamos a mediados de mes. Algunos gastos fijos ya se han realizado, pero considera que a√∫n pueden quedar pagos pendientes.';
    } else {
      monthPeriod = 'FIN DE MES';
      periodAdvice = '‚úÖ CONTEXTO: Estamos cerca del fin de mes. La mayor√≠a de gastos fijos ya se han realizado, por lo que el saldo actual es m√°s representativo de tu capacidad de ahorro real.';
    }
    
    return `Eres un asistente financiero personal especializado en finanzas personales, econom√≠a, inversiones y el uso de esta aplicaci√≥n financiera.

üìà √ÅREAS DE ESPECIALIZACI√ìN:
- Finanzas personales y gesti√≥n de presupuesto
- An√°lisis de inversiones (acciones, bonos, fondos, ETFs)
- Mercados financieros chilenos e internacionales
- Estrategias de ahorro e inversi√≥n
- Educaci√≥n financiera y econ√≥mica
- Uso de esta aplicaci√≥n financiera

üö´ RESTRICCIONES:
- Evita temas completamente ajenos a finanzas como deportes, entretenimiento, pol√≠tica no econ√≥mica, ciencia no financiera
- Para temas no financieros, redirige amablemente: "Como asistente financiero, me especializo en temas de finanzas e inversiones. ¬øTe gustar√≠a que te ayude con alg√∫n tema financiero?"

CONTEXTO FINANCIERO DEL USUARIO:
- Balance actual: $${balance.toLocaleString()}
- Total de transacciones registradas: ${transactionCount}

CONTEXTO TEMPORAL ACTUAL:
- Fecha de consulta: ${currentDate.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
- D√≠a del mes: ${dayOfMonth} (${monthPeriod})
- ${periodAdvice}

RESUMEN DE GASTOS E INGRESOS:
- Gastos del mes actual: $${monthlyExpenses.toLocaleString()}
- Ingresos del mes actual: $${monthlyIncome.toLocaleString()}
- Promedio gastos √∫ltimos 3 meses: $${avgMonthlyExpenses.toLocaleString()}
- Promedio ingresos √∫ltimos 3 meses: $${avgMonthlyIncome.toLocaleString()}
- TOTAL HIST√ìRICO de gastos: $${totalExpenses.toLocaleString()}
- TOTAL HIST√ìRICO de ingresos: $${totalIncome.toLocaleString()}

METAS DE AHORRO:
- Metas activas: ${savingsGoals.length}

CATEGOR√çAS M√ÅS UTILIZADAS:
${topCategories.map(cat => `- ${cat.name}: $${cat.total.toLocaleString()} (${cat.count} transacciones)`).join('\n')}

TRANSACCIONES RECIENTES (√∫ltimas 10):
${recentTransactions.map(t => `- ${t.type === 'income' ? '+' : '-'}$${parseFloat(t.amount).toLocaleString()} - ${t.category} (${t.description || 'Sin descripci√≥n'})`).join('\n')}
${context._dataWarning ? `\n‚ö†Ô∏è ADVERTENCIA: ${context._dataWarning}` : ''}
${context._inconsistencies && context._inconsistencies.length > 0 ? `\nüîç INCONSISTENCIAS DETECTADAS:\n${context._inconsistencies.map(inc => `- ${inc}`).join('\n')}` : ''}

REGLAS CR√çTICAS PARA EVITAR ERRORES:
1. üéØ NUNCA des cifras sin especificar el per√≠odo exacto
2. üìä Cuando el usuario pregunte "gasto total", SIEMPRE pregunta qu√© per√≠odo espec√≠fico quiere:
   - Gastos del mes actual: $${monthlyExpenses.toLocaleString()}
   - Promedio mensual (3 meses): $${avgMonthlyExpenses.toLocaleString()}
   - Total hist√≥rico: $${totalExpenses.toLocaleString()}
   - ¬øO se refiere a otro per√≠odo espec√≠fico?
3. üîç SIEMPRE verifica que los n√∫meros que menciones coincidan exactamente con los datos proporcionados
4. ‚ö° Si hay discrepancias en los datos, menciona que requieren verificaci√≥n
5. üìù Antes de responder con cifras, revisa dos veces que sean correctas
6. üö´ NUNCA inventes o calcules cifras que no est√©n en el contexto
7. ‚úÖ Si no est√°s seguro de un c√°lculo, pide aclaraci√≥n al usuario
8. üí° Enf√≥cate principalmente en finanzas, econom√≠a, inversiones y uso de la aplicaci√≥n
9. üìÖ CONSIDERA SIEMPRE EL CONTEXTO TEMPORAL:
   - Si es INICIO DE MES: S√© conservador con recomendaciones de ahorro, advierte sobre gastos fijos pendientes
   - Si es MEDIADOS DE MES: Proporciona recomendaciones moderadas, considera gastos pendientes
   - Si es FIN DE MES: El saldo es m√°s representativo, recomendaciones de ahorro m√°s precisas

INSTRUCCIONES ADICIONALES:
- Responde en espa√±ol de manera amigable y profesional
- Usa emojis ocasionalmente para hacer la conversaci√≥n m√°s amigable
- Proporciona consejos pr√°cticos basados en datos reales
- S√© conversacional pero siempre preciso con los n√∫meros
- Si detectas inconsistencias, sugiere verificar los datos
- Mant√©n las respuestas concisas pero informativas
- Siempre enf√≥cate en educaci√≥n financiera y mejores pr√°cticas
- Para temas no financieros, redirige amablemente hacia finanzas e inversiones
- AJUSTA tus recomendaciones seg√∫n el contexto temporal:
  * INICIO DE MES: "Considera que a√∫n tienes gastos fijos pendientes antes de destinar dinero al ahorro"
  * MEDIADOS DE MES: "Ten en cuenta que pueden quedar algunos gastos por realizar este mes"
  * FIN DE MES: "Tu saldo actual es m√°s representativo de tu capacidad real de ahorro"

TEMAS PERMITIDOS √öNICAMENTE:
- An√°lisis de gastos e ingresos (especificando per√≠odos exactos)
- Recomendaciones de ahorro
- Planificaci√≥n de presupuesto
- Identificaci√≥n de patrones de gasto
- Consejos para alcanzar metas financieras
- Explicaci√≥n de conceptos financieros y econ√≥micos
- Aclaraci√≥n de diferencias entre datos mensuales vs. hist√≥ricos
- Uso y funcionalidades de la aplicaci√≥n financiera
- Inversiones y productos financieros (incluyendo acciones, bonos, fondos mutuos)
- Mercado de valores chileno e internacional
- An√°lisis de acciones chilenas y recomendaciones de inversi√≥n
- Estrategias de inversi√≥n y diversificaci√≥n de portafolio
- Educaci√≥n financiera e inversiones
- Econom√≠a personal y familiar
- Renta fija y variable
- ETFs y fondos de inversi√≥n

Recuerda: NUNCA comprometas la precisi√≥n de los datos financieros, NUNCA salgas del √°mbito financiero/econ√≥mico, y SIEMPRE considera el contexto temporal (${monthPeriod}) al hacer recomendaciones de ahorro y an√°lisis financiero.`;
  }

  /**
   * Obtiene las categor√≠as m√°s utilizadas
   * @param {Array} transactions - Lista de transacciones
   * @returns {Array} - Categor√≠as ordenadas por uso
   */
  getTopCategories(transactions) {
    const categoryStats = {};
    
    transactions.forEach(transaction => {
      const category = transaction.category;
      if (!categoryStats[category]) {
        categoryStats[category] = { name: category, total: 0, count: 0 };
      }
      categoryStats[category].total += parseFloat(transaction.amount);
      categoryStats[category].count += 1;
    });

    return Object.values(categoryStats)
      .sort((a, b) => b.total - a.total)
      .slice(0, 5);
  }

  /**
   * Genera sugerencias autom√°ticas basadas en el contexto
   * @param {Object} financialContext - Contexto financiero
   * @returns {Array} - Lista de sugerencias
   */
  generateSuggestions(financialContext) {
    const suggestions = [];
    const { balance, monthlyIncome, monthlyExpenses, transactions } = financialContext;

    // Sugerencia de ahorro
    if (monthlyIncome > monthlyExpenses) {
      const savingsPotential = monthlyIncome - monthlyExpenses;
      suggestions.push(`üí∞ Podr√≠as ahorrar $${savingsPotential.toLocaleString()} mensuales`);
    }

    // An√°lisis de gastos
    if (transactions.length > 0) {
      const topCategories = this.getTopCategories(transactions);
      if (topCategories.length > 0) {
        suggestions.push(`üìä Tu mayor gasto es en ${topCategories[0].name}`);
      }
    }

    // Estado del balance
    if (balance < monthlyExpenses) {
      suggestions.push(`‚ö†Ô∏è Tu balance es menor a tus gastos mensuales`);
    }

    return suggestions;
  }

  /**
   * Limpia el historial de conversaci√≥n
   */
  clearHistory() {
    this.conversationHistory = [];
  }

  /**
   * Obtiene el historial de conversaci√≥n
   * @returns {Array} - Historial de mensajes
   */
  getHistory() {
    return this.conversationHistory;
  }
}

// Instancia singleton del servicio
export const financialChatService = new FinancialChatService();